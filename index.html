<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D365 Demo Data Generator</title>
    <meta name="description" content="Generate realistic demo data for Microsoft Dynamics 365 Sales">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://alcdn.msauth.net/browser/2.28.1/js/msal-browser.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #0078d4 0%, #106ebe 100%);
            min-height: 100vh;
            color: #323130;
            line-height: 1.6;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            border-radius: 8px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }

        .header h1 {
            color: #323130;
            margin-bottom: 10px;
            font-size: 2em;
        }

        .header p {
            color: #605e5c;
            margin-bottom: 20px;
        }

        .demo-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .demo-btn {
            background: white;
            border: 2px solid #0078d4;
            color: #0078d4;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .demo-btn:hover {
            background: #f3f9fd;
        }

        .demo-btn.selected {
            background: #0078d4;
            color: white;
        }

        .main-content {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .section {
            padding: 30px;
            border-bottom: 1px solid #f3f2f1;
        }

        .section:last-child {
            border-bottom: none;
        }

        .section h2 {
            color: #323130;
            margin-bottom: 20px;
            font-size: 1.3em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .step-number {
            background: #0078d4;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #323130;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #edebe9;
            border-radius: 4px;
            font-size: 14px;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #0078d4;
        }

        .scenario-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .scenario-card {
            border: 2px solid #edebe9;
            border-radius: 6px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .scenario-card:hover {
            border-color: #0078d4;
        }

        .scenario-card.selected {
            border-color: #0078d4;
            background: #f3f9fd;
        }

        .scenario-title {
            font-weight: bold;
            margin-bottom: 8px;
            color: #323130;
        }

        .scenario-description {
            color: #605e5c;
            font-size: 0.9em;
            margin-bottom: 10px;
        }

        .scenario-features {
            list-style: none;
        }

        .scenario-features li {
            color: #107c10;
            font-size: 0.8em;
            margin-bottom: 3px;
        }

        .scenario-features li:before {
            content: "‚úì ";
            font-weight: bold;
        }

        .btn {
            background: #0078d4;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover:not(:disabled) {
            background: #106ebe;
        }

        .btn:disabled {
            background: #c8c6c4;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #605e5c;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #484644;
        }

        .status {
            padding: 12px;
            border-radius: 4px;
            margin: 15px 0;
        }

        .status-success {
            background: #dff6dd;
            color: #107c10;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background: #fde7e9;
            color: #d13438;
            border: 1px solid #f5c6cb;
        }

        .status-info {
            background: #deecf9;
            color: #0078d4;
            border: 1px solid #bee5eb;
        }

        .status-warning {
            background: #fff4ce;
            color: #8a8100;
            border: 1px solid #ffeaa7;
        }

        .progress-container {
            background: #f3f2f1;
            height: 6px;
            border-radius: 3px;
            margin: 15px 0;
            overflow: hidden;
        }

        .progress-bar {
            background: #0078d4;
            height: 100%;
            width: 0%;
            transition: width 0.5s ease;
        }

        .log {
            background: #323130;
            color: white;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 250px;
            overflow-y: auto;
            margin: 15px 0;
            white-space: pre-wrap;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat {
            background: #f3f9fd;
            padding: 15px;
            border-radius: 4px;
            text-align: center;
            border: 1px solid #deecf9;
        }

        .stat-number {
            font-size: 1.5em;
            font-weight: bold;
            color: #0078d4;
        }

        .stat-label {
            color: #605e5c;
            font-size: 0.8em;
            text-transform: uppercase;
            margin-top: 5px;
        }

        .preview {
            background: #f3f9fd;
            border: 1px solid #deecf9;
            padding: 15px;
            border-radius: 4px;
            margin: 15px 0;
        }

        .preview h4 {
            margin-bottom: 8px;
            color: #323130;
        }

        .preview ul {
            margin-left: 15px;
            color: #605e5c;
        }

        .hidden {
            display: none !important;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .demo-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .demo-btn {
                width: 100%;
                max-width: 300px;
            }
            
            .scenario-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>D365 Demo Data Generator</h1>
            <p>Generate realistic demo data for Microsoft Dynamics 365 Sales</p>
            
            <div class="demo-buttons">
                <button class="demo-btn" id="contosoBtn">‚òï Contoso Coffee</button>
                <button class="demo-btn" id="customBtn">üè¢ Custom Demo</button>
            </div>
        </div>

        <div class="main-content">
            <!-- Configuration -->
            <div class="section">
                <h2><span class="step-number">1</span>Configuration</h2>

                <div id="customForm" class="hidden">
                    <div class="form-group">
                        <label>Customer Name</label>
                        <input type="text" id="customerName" placeholder="Enter customer name">
                    </div>
                    <div class="form-group">
                        <label>Industry</label>
                        <select id="industry">
                            <option value="">Select industry...</option>
                            <option value="Manufacturing">Manufacturing</option>
                            <option value="Healthcare">Healthcare</option>
                            <option value="Financial Services">Financial Services</option>
                            <option value="Technology">Technology</option>
                            <option value="Retail">Retail</option>
                            <option value="Education">Education</option>
                        </select>
                    </div>
                    <div id="customPreview" class="preview hidden"></div>
                </div>

                <div id="contosoPreview" class="preview hidden">
                    <h4>Contoso Coffee Demo</h4>
                    <ul>
                        <li>Industry: Food & Beverage</li>
                        <li>Products: Coffee beans, equipment, training</li>
                        <li>Customers: Coffee shops, restaurants</li>
                    </ul>
                </div>

                <div id="scenarioSection" class="hidden">
                    <label>Sales Scenario</label>
                    <div class="scenario-grid">
                        <div class="scenario-card" id="coreCard">
                            <div class="scenario-title">Core Sales</div>
                            <div class="scenario-description">Traditional sales process</div>
                            <ul class="scenario-features">
                                <li>12 sales reps</li>
                                <li>100 accounts</li>
                                <li>500 opportunities</li>
                            </ul>
                        </div>
                        <div class="scenario-card" id="agenticCard">
                            <div class="scenario-title">AI Sales</div>
                            <div class="scenario-description">With AI agents</div>
                            <ul class="scenario-features">
                                <li>Deal Close Agent</li>
                                <li>1-7 day cycles</li>
                                <li>85% win rate</li>
                            </ul>
                        </div>
                        <div class="scenario-card" id="completeCard">
                            <div class="scenario-title">Complete</div>
                            <div class="scenario-description">Full platform</div>
                            <ul class="scenario-features">
                                <li>All features</li>
                                <li>AI + Human reps</li>
                                <li>Advanced analytics</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Authentication -->
            <div class="section">
                <h2><span class="step-number">2</span>Authentication</h2>
                <p style="margin-bottom: 15px;">Connect to your Microsoft 365 account to access D365 environments.</p>
                <button class="btn" id="authBtn">üîê Sign In</button>
                <div id="authStatus"></div>
            </div>

            <!-- Generation -->
            <div class="section">
                <h2><span class="step-number">3</span>Generate Data</h2>
                <div class="status status-warning">
                    ‚ö†Ô∏è This will create demo data in your D365 environment.
                </div>
                <button class="btn" id="generateBtn" disabled>‚ú® Generate Data</button>
                <button class="btn btn-secondary hidden" id="downloadBtn">üì• Download CSV</button>
                
                <div id="progressContainer" class="progress-container hidden">
                    <div class="progress-bar" id="progressBar"></div>
                </div>
                <div id="progressText" style="text-align: center; color: #605e5c; margin: 10px 0;" class="hidden"></div>
                <div id="log" class="log hidden"></div>
                <div id="stats" class="stats hidden"></div>
                <div id="successMsg" class="status status-success hidden">
                    üéâ Demo data generated successfully!
                </div>
            </div>
        </div>
    </div>

    <script>
        // App state
        const state = {
            demoType: '',
            scenario: '',
            customerName: '',
            industry: '',
            authenticated: false,
            selectedOrg: null,
            generatedData: {}
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            setupEvents();
        });

        function setupEvents() {
            document.getElementById('contosoBtn').onclick = () => selectDemo('contoso');
            document.getElementById('customBtn').onclick = () => selectDemo('custom');
            document.getElementById('customerName').oninput = updatePreview;
            document.getElementById('industry').onchange = updatePreview;
            document.getElementById('coreCard').onclick = () => selectScenario('core');
            document.getElementById('agenticCard').onclick = () => selectScenario('agentic');
            document.getElementById('completeCard').onclick = () => selectScenario('complete');
            document.getElementById('authBtn').onclick = authenticate;
            document.getElementById('generateBtn').onclick = generateData;
            document.getElementById('downloadBtn').onclick = downloadFiles;
        }

        function selectDemo(type) {
            state.demoType = type;
            
            // Update buttons
            document.querySelectorAll('.demo-btn').forEach(btn => btn.classList.remove('selected'));
            document.getElementById(type + 'Btn').classList.add('selected');
            
            // Show/hide forms
            const customForm = document.getElementById('customForm');
            const contosoPreview = document.getElementById('contosoPreview');
            const scenarioSection = document.getElementById('scenarioSection');
            
            if (type === 'custom') {
                customForm.classList.remove('hidden');
                contosoPreview.classList.add('hidden');
            } else {
                customForm.classList.add('hidden');
                contosoPreview.classList.remove('hidden');
            }
            
            scenarioSection.classList.remove('hidden');
            updateGenerateButton();
        }

        function updatePreview() {
            state.customerName = document.getElementById('customerName').value;
            state.industry = document.getElementById('industry').value;
            
            const preview = document.getElementById('customPreview');
            
            if (state.customerName && state.industry) {
                const products = getIndustryProducts(state.industry);
                preview.innerHTML = `
                    <h4>${state.customerName} Demo</h4>
                    <ul>
                        <li>Industry: ${state.industry}</li>
                        <li>Products: ${products.join(', ')}</li>
                        <li>Tailored scenarios and campaigns</li>
                    </ul>
                `;
                preview.classList.remove('hidden');
            } else {
                preview.classList.add('hidden');
            }
            
            updateGenerateButton();
        }

        function selectScenario(scenario) {
            state.scenario = scenario;
            
            // Update cards
            document.querySelectorAll('.scenario-card').forEach(card => card.classList.remove('selected'));
            document.getElementById(scenario + 'Card').classList.add('selected');
            
            updateGenerateButton();
        }

        function updateGenerateButton() {
            const hasConfig = state.demoType && state.scenario && 
                (state.demoType === 'contoso' || (state.customerName && state.industry));
            const btn = document.getElementById('generateBtn');
            btn.disabled = !hasConfig;
        }

        async function authenticate() {
            try {
                showStatus('Initializing authentication...', 'info');
                
                // Initialize MSAL
                await initializeMSAL();
                
                showStatus('Opening sign-in window...', 'info');
                
                // Step 1: Authenticate with Microsoft
                const loginRequest = {
                    scopes: ['https://admin.services.crm.dynamics.com/user_impersonation'],
                    prompt: 'select_account'
                };

                const response = await state.msalInstance.loginPopup(loginRequest);
                state.accessToken = response.accessToken;
                
                showStatus('Loading your Dynamics 365 organizations...', 'info');
                
                // Step 2: Get available D365 organizations
                await loadD365Organizations();
                
            } catch (error) {
                console.error('Authentication failed:', error);
                if (error.name === 'BrowserAuthError') {
                    showStatus('‚ùå Authentication cancelled or failed. Please try again.', 'error');
                } else if (error.message.includes('popup_window_error')) {
                    showStatus('‚ùå Popup blocked. Please allow popups and try again.', 'error');
                } else {
                    showStatus('‚ùå Authentication failed: ' + error.message, 'error');
                }
            }
        }

        async function initializeMSAL() {
            if (state.msalInstance) return;
            
            const msalConfig = {
                auth: {
                    clientId: '51f81489-12ee-4a9e-aaae-a2591f45987d', // Microsoft's common client ID
                    authority: 'https://login.microsoftonline.com/common',
                    redirectUri: window.location.origin
                },
                cache: {
                    cacheLocation: 'sessionStorage',
                    storeAuthStateInCookie: false
                },
                system: {
                    loggerOptions: {
                        loggerCallback: (level, message) => {
                            if (level === msal.LogLevel.Error) {
                                console.error('MSAL Error:', message);
                            }
                        },
                        piiLoggingEnabled: false,
                        logLevel: msal.LogLevel.Warning
                    }
                }
            };

            state.msalInstance = new msal.PublicClientApplication(msalConfig);
            await state.msalInstance.initialize();
        }

        async function loadD365Organizations() {
            try {
                const response = await fetch('https://admin.services.crm.dynamics.com/api/v1.0/instances', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${state.accessToken}`,
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    if (response.status === 403) {
                        throw new Error('Access denied. You may not have permissions to view Dynamics 365 organizations.');
                    } else if (response.status === 401) {
                        throw new Error('Authentication token expired. Please try signing in again.');
                    } else {
                        throw new Error(`Failed to load organizations (${response.status})`);
                    }
                }

                const data = await response.json();
                const organizations = data.value || [];

                if (organizations.length === 0) {
                    showStatus('‚ùå No Dynamics 365 organizations found in your tenant.', 'warning');
                    return;
                }

                showOrganizationSelector(organizations);

            } catch (error) {
                console.error('Failed to load D365 organizations:', error);
                showStatus('‚ùå Failed to load organizations: ' + error.message, 'error');
            }
        }

        function showOrganizationSelector(organizations) {
            // Clear existing auth status and show org selector
            const authSection = document.querySelector('#authStatus').parentElement;
            
            // Create organization selector UI
            const orgSelector = document.createElement('div');
            orgSelector.id = 'orgSelector';
            orgSelector.innerHTML = `
                <div style="margin: 15px 0;">
                    <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #323130;">
                        Select your Dynamics 365 organization:
                    </label>
                    <div id="orgList" style="border: 1px solid #edebe9; border-radius: 4px; max-height: 200px; overflow-y: auto;">
                        ${organizations.map(org => `
                            <div class="org-item" data-org-id="${org.Id}" data-org-url="${org.Url}" style="
                                padding: 12px; 
                                border-bottom: 1px solid #f3f2f1; 
                                cursor: pointer;
                                transition: background 0.2s;
                            " onmouseover="this.style.background='#f3f9fd'" onmouseout="this.style.background='white'">
                                <div style="font-weight: 600; color: #323130;">${org.FriendlyName}</div>
                                <div style="font-size: 0.85em; color: #605e5c; margin-top: 2px;">${org.Url}</div>
                                <div style="font-size: 0.8em; color: #605e5c;">Region: ${org.Region || 'Not specified'} | Version: ${org.Version || 'Unknown'}</div>
                            </div>
                        `).join('')}
                    </div>
                    <button class="btn" id="confirmOrgBtn" disabled style="margin-top: 15px;">
                        Connect to Selected Organization
                    </button>
                    <button class="btn btn-secondary" id="cancelAuthBtn" style="margin-top: 15px;">
                        Cancel
                    </button>
                </div>
            `;

            // Remove existing org selector if present
            const existing = document.getElementById('orgSelector');
            if (existing) existing.remove();

            // Add new org selector
            authSection.appendChild(orgSelector);

            // Add click handlers for organization selection
            const orgItems = orgSelector.querySelectorAll('.org-item');
            orgItems.forEach(item => {
                item.addEventListener('click', () => {
                    // Remove selection from all items
                    orgItems.forEach(i => {
                        i.style.background = 'white';
                        i.style.borderLeft = 'none';
                    });
                    
                    // Select clicked item
                    item.style.background = '#deecf9';
                    item.style.borderLeft = '3px solid #0078d4';
                    
                    // Store selected organization
                    state.selectedOrg = {
                        id: item.dataset.orgId,
                        url: item.dataset.orgUrl,
                        name: item.querySelector('div').textContent
                    };
                    
                    // Enable confirm button
                    document.getElementById('confirmOrgBtn').disabled = false;
                });
            });

            // Add confirm button handler
            document.getElementById('confirmOrgBtn').addEventListener('click', confirmOrganization);
            
            // Add cancel button handler
            document.getElementById('cancelAuthBtn').addEventListener('click', () => {
                orgSelector.remove();
                showStatus('Authentication cancelled', 'info');
                state.authenticated = false;
                state.selectedOrg = null;
                updateGenerateButton();
            });

            showStatus('‚úÖ Organizations loaded. Please select one to continue.', 'success');
        }

        async function confirmOrganization() {
            if (!state.selectedOrg) {
                showStatus('‚ùå Please select an organization first', 'error');
                return;
            }

            try {
                showStatus('Connecting to your organization...', 'info');

                // Get organization-specific token
                const tokenRequest = {
                    scopes: [state.selectedOrg.url + 'user_impersonation'],
                    account: state.msalInstance.getAllAccounts()[0]
                };

                const response = await state.msalInstance.acquireTokenSilent(tokenRequest);
                state.accessToken = response.accessToken;
                state.d365BaseUrl = state.selectedOrg.url.endsWith('/') ? state.selectedOrg.url : state.selectedOrg.url + '/';

                // Test the connection
                await testD365Connection();

                // Success - clean up UI and update state
                const orgSelector = document.getElementById('orgSelector');
                if (orgSelector) orgSelector.remove();

                state.authenticated = true;
                showStatus(`‚úÖ Connected to ${state.selectedOrg.name}`, 'success');
                updateGenerateButton();

                showLog(`Connected to D365 organization: ${state.selectedOrg.name}`);
                showLog(`Organization URL: ${state.selectedOrg.url}`);

            } catch (error) {
                console.error('Failed to connect to organization:', error);
                
                if (error.name === 'InteractionRequiredAuthError') {
                    showStatus('‚ùå Additional authentication required. Please try signing in again.', 'error');
                } else {
                    showStatus('‚ùå Failed to connect to organization: ' + error.message, 'error');
                }
            }
        }

        async function testD365Connection() {
            try {
                const response = await fetch(state.d365BaseUrl + 'api/data/v9.2/WhoAmI', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${state.accessToken}`,
                        'Accept': 'application/json',
                        'OData-MaxVersion': '4.0',
                        'OData-Version': '4.0'
                    }
                });

                if (!response.ok) {
                    throw new Error(`Connection test failed (${response.status})`);
                }

                const data = await response.json();
                showLog(`Connection verified - User ID: ${data.UserId}`);
                
            } catch (error) {
                throw new Error(`Unable to connect to D365: ${error.message}`);
            }
        }

        async function generateData() {
            if (!state.authenticated) {
                showStatus('Please authenticate first', 'error');
                return;
            }

            showProgress(0, 'Starting generation...');
            showLog('üéØ Generating demo data');
            showLog(`Type: ${state.demoType}`);
            showLog(`Scenario: ${state.scenario}`);

            try {
                // Generate data
                await createDemoData();
                showProgress(100, 'Complete!');
                showSuccess();
                
            } catch (error) {
                showLog('‚ùå Error: ' + error.message);
                showStatus('Generation failed', 'error');
            }
        }

        async function createDemoData() {
            const config = getScenarioConfig();
            
            showProgress(10, 'Creating entities...');
            
            state.generatedData = {
                currencies: createCurrencies(),
                businessunits: createBusinessUnits(),
                users: createUsers(config),
                territories: createTerritories(),
                campaigns: createCampaigns(),
                products: createProducts(),
                accounts: createAccounts(config.accounts),
                contacts: createContacts(),
                opportunities: createOpportunities(config.opportunities),
                opportunityproducts: []
            };

            showProgress(50, 'Adding products to opportunities...');
            state.generatedData.opportunityproducts = createOpportunityProducts();

            showProgress(80, 'Finalizing...');
            await delay(500);

            // Log results
            Object.keys(state.generatedData).forEach(key => {
                const count = state.generatedData[key].length;
                showLog(`‚úÖ ${key}: ${count} records`);
            });
        }

        function getScenarioConfig() {
            const configs = {
                core: { users: 12, accounts: 100, opportunities: 500 },
                agentic: { users: 13, accounts: 100, opportunities: 500 }, // +1 for AI agent
                complete: { users: 15, accounts: 150, opportunities: 750 }
            };
            return configs[state.scenario];
        }

        // Data generation functions
        function createCurrencies() {
            return [{
                id: generateId(),
                name: 'US Dollar',
                code: 'USD',
                symbol: '$'
            }];
        }

        function createBusinessUnits() {
            const name = state.demoType === 'contoso' ? 'Contoso Coffee' : state.customerName;
            return [{
                id: generateId(),
                name: `${name} Sales`,
                description: `Sales organization for ${name}`
            }];
        }

        function createUsers(config) {
            const users = [];
            const names = [
                'Julie Chen', 'Eric Johnson', 'Michael Davis', 'Deepak Patel', 'Pooja Singh',
                'Sarah Wilson', 'David Brown', 'Lisa Anderson', 'Robert Martinez', 'Jennifer Taylor'
            ];

            for (let i = 0; i < Math.min(config.users, names.length); i++) {
                const [first, last] = names[i].split(' ');
                users.push({
                    id: generateId(),
                    firstName: first,
                    lastName: last,
                    email: `${first.toLowerCase()}.${last.toLowerCase()}@company.com`,
                    fullName: names[i]
                });
            }

            if (state.scenario === 'agentic' || state.scenario === 'complete') {
                users.push({
                    id: generateId(),
                    firstName: 'Deal Close',
                    lastName: 'Agent',
                    email: 'dealclose.agent@company.com',
                    fullName: 'Deal Close Agent'
                });
            }

            return users;
        }

        function createTerritories() {
            return ['North America', 'Europe', 'Asia Pacific'].map(name => ({
                id: generateId(),
                name: name
            }));
        }

        function createCampaigns() {
            let campaigns;
            if (state.demoType === 'custom' && state.industry) {
                campaigns = getIndustryCampaigns(state.industry);
            } else {
                campaigns = ['Q1 Launch', 'Summer Promo', 'Holiday Special'];
            }

            return campaigns.map(name => ({
                id: generateId(),
                name: name
            }));
        }

        function createProducts() {
            let products;
            if (state.demoType === 'custom' && state.industry) {
                products = getIndustryProducts(state.industry).map(name => ({
                    name: name,
                    price: Math.floor(Math.random() * 10000) + 100
                }));
            } else {
                products = [
                    { name: 'Premium Coffee Beans', price: 24.99 },
                    { name: 'Espresso Machine', price: 1299.99 },
                    { name: 'Coffee Training', price: 299.99 },
                    { name: 'Franchise Package', price: 45000.00 }
                ];
            }

            return products.map(p => ({
                id: generateId(),
                name: p.name,
                code: `PRD-${Math.random().toString(36).substr(2, 4).toUpperCase()}`,
                price: p.price
            }));
        }

        function createAccounts(count) {
            const accounts = [];
            const territories = state.generatedData.territories;
            const users = state.generatedData.users;

            for (let i = 0; i < count; i++) {
                const name = state.demoType === 'custom' ?
                    generateCustomerAccount(state.industry) :
                    generateContosoAccount();

                accounts.push({
                    id: generateId(),
                    name: name,
                    phone: generatePhone(),
                    city: getRandomCity(),
                    revenue: Math.floor(Math.random() * 5000000) + 100000,
                    territory: territories[Math.floor(Math.random() * territories.length)].id,
                    owner: users[Math.floor(Math.random() * users.length)].id
                });
            }

            return accounts;
        }

        function createContacts() {
            const contacts = [];
            const accounts = state.generatedData.accounts;

            accounts.forEach(account => {
                const count = Math.floor(Math.random() * 3) + 1;
                for (let i = 0; i < count; i++) {
                    const first = getRandomFirstName();
                    const last = getRandomLastName();
                    contacts.push({
                        id: generateId(),
                        firstName: first,
                        lastName: last,
                        email: `${first.toLowerCase()}.${last.toLowerCase()}@company.com`,
                        title: getRandomTitle(),
                        account: account.id
                    });
                }
            });

            return contacts;
        }

        function createOpportunities(count) {
            const opportunities = [];
            const accounts = state.generatedData.accounts;
            const contacts = state.generatedData.contacts;
            const campaigns = state.generatedData.campaigns;
            const users = state.generatedData.users;

            for (let i = 0; i < count; i++) {
                const account = accounts[Math.floor(Math.random() * accounts.length)];
                const accountContacts = contacts.filter(c => c.account === account.id);
                const contact = accountContacts[Math.floor(Math.random() * accountContacts.length)];
                const owner = users[Math.floor(Math.random() * users.length)];

                const isDealCloseAgent = owner.fullName === 'Deal Close Agent';
                const createdDate = new Date(Date.now() - Math.random() * 365 * 24 * 60 * 60 * 1000);

                let status, probability, actualRevenue = null;
                let estimatedClose;

                if (isDealCloseAgent) {
                    // AI agent: 1-7 days, 85% win rate
                    estimatedClose = new Date(createdDate.getTime() + (Math.random() * 7 + 1) * 24 * 60 * 60 * 1000);
                    if (Math.random() < 0.85) {
                        status = 'Won';
                        probability = 100;
                    } else {
                        status = 'Lost';
                        probability = 0;
                    }
                } else {
                    // Human: 30-120 days, varied rates
                    estimatedClose = new Date(createdDate.getTime() + (Math.random() * 90 + 30) * 24 * 60 * 60 * 1000);
                    const winRate = ['Julie', 'Eric', 'Michael'].includes(owner.firstName) ? 0.65 : 0.45;

                    if (estimatedClose < new Date() && Math.random() < winRate) {
                        status = 'Won';
                        probability = 100;
                    } else {
                        status = 'Open';
                        probability = Math.floor(Math.random() * 80) + 10;
                    }
                }

                opportunities.push({
                    id: generateId(),
                    name: `${account.name} - New Business`,
                    account: account.id,
                    contact: contact ? contact.id : null,
                    owner: owner.id,
                    campaign: campaigns[Math.floor(Math.random() * campaigns.length)].id,
                    estimatedRevenue: 0, // Will be calculated
                    actualRevenue: actualRevenue,
                    probability: probability,
                    status: status,
                    estimatedClose: estimatedClose.toISOString().split('T')[0],
                    created: createdDate.toISOString()
                });
            }

            return opportunities;
        }

        function createOpportunityProducts() {
            const products = [];
            const opportunities = state.generatedData.opportunities;
            const productCatalog = state.generatedData.products;

            opportunities.forEach(opp => {
                const numProducts = Math.floor(Math.random() * 3) + 1;
                let totalRevenue = 0;

                for (let i = 0; i < numProducts; i++) {
                    const product = productCatalog[Math.floor(Math.random() * productCatalog.length)];
                    const quantity = Math.floor(Math.random() * 5) + 1;
                    const unitPrice = product.price * (0.8 + Math.random() * 0.4);
                    const totalPrice = quantity * unitPrice;

                    products.push({
                        id: generateId(),
                        opportunity: opp.id,
                        product: product.id,
                        quantity: quantity,
                        unitPrice: Math.round(unitPrice * 100) / 100,
                        totalPrice: Math.round(totalPrice * 100) / 100
                    });

                    totalRevenue += totalPrice;
                }

                // Update opportunity revenue
                opp.estimatedRevenue = Math.round(totalRevenue * 100) / 100;
                if (opp.status === 'Won') {
                    opp.actualRevenue = Math.round(totalRevenue * 100) / 100;
                }
            });

            return products;
        }

        // Industry data
        function getIndustryProducts(industry) {
            const products = {
                'Manufacturing': ['Industrial Equipment', 'Quality Systems', 'Maintenance Services'],
                'Healthcare': ['Medical Devices', 'Healthcare Software', 'Training Programs'],
                'Financial Services': ['Banking Solutions', 'Risk Management', 'Compliance Tools'],
                'Technology': ['Software Licenses', 'Cloud Services', 'Technical Support'],
                'Retail': ['POS Systems', 'Inventory Management', 'Customer Analytics'],
                'Education': ['Learning Systems', 'Student Management', 'EdTech Solutions']
            };
            return products[industry] || ['Professional Services', 'Consulting', 'Support'];
        }

        function getIndustryCampaigns(industry) {
            const campaigns = {
                'Manufacturing': ['Industry 4.0', 'Safety Excellence'],
                'Healthcare': ['Digital Health', 'Patient Care'],
                'Financial Services': ['Digital Banking', 'Risk Mitigation'],
                'Technology': ['Cloud Migration', 'AI Innovation'],
                'Retail': ['Omnichannel', 'Customer Data'],
                'Education': ['Digital Learning', 'Student Success']
            };
            return campaigns[industry] || ['Business Excellence', 'Innovation'];
        }

        function generateCustomerAccount(industry) {
            const prefixes = ['Global', 'Premier', 'Advanced'];
            const suffixes = {
                'Manufacturing': ['Manufacturing', 'Industries'],
                'Healthcare': ['Medical', 'Healthcare'],
                'Financial Services': ['Bank', 'Financial'],
                'Technology': ['Tech', 'Systems'],
                'Retail': ['Retail', 'Store'],
                'Education': ['University', 'Institute']
            };
            
            const prefix = prefixes[Math.floor(Math.random() * prefixes.length)];
            const suffixList = suffixes[industry] || ['Company'];
            const suffix = suffixList[Math.floor(Math.random() * suffixList.length)];
            
            return `${prefix} ${suffix}`;
        }

        function generateContosoAccount() {
            const names = ['Bean & Brew', 'Coffee Corner', 'Daily Grind', 'Java Junction'];
            const suffixes = ['Cafe', 'Coffee House', 'Roastery'];
            const name = names[Math.floor(Math.random() * names.length)];
            const suffix = suffixes[Math.floor(Math.random() * suffixes.length)];
            return `${name} ${suffix}`;
        }

        // Utility functions
        function generateId() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        function generatePhone() {
            return `+1-${Math.floor(Math.random() * 900) + 100}-${Math.floor(Math.random() * 900) + 100}-${Math.floor(Math.random() * 9000) + 1000}`;
        }

        function getRandomCity() {
            const cities = ['New York', 'Los Angeles', 'Chicago', 'Houston', 'Phoenix'];
            return cities[Math.floor(Math.random() * cities.length)];
        }

        function getRandomFirstName() {
            const names = ['John', 'Jane', 'Mike', 'Sarah', 'David', 'Lisa'];
            return names[Math.floor(Math.random() * names.length)];
        }

        function getRandomLastName() {
            const names = ['Smith', 'Johnson', 'Williams', 'Brown', 'Jones'];
            return names[Math.floor(Math.random() * names.length)];
        }

        function getRandomTitle() {
            const titles = ['CEO', 'VP Sales', 'Director', 'Manager', 'Coordinator'];
            return titles[Math.floor(Math.random() * titles.length)];
        }

        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // UI functions
        function showProgress(percent, text) {
            const container = document.getElementById('progressContainer');
            const bar = document.getElementById('progressBar');
            const textEl = document.getElementById('progressText');
            
            container.classList.remove('hidden');
            bar.style.width = percent + '%';
            
            if (text) {
                textEl.textContent = text;
                textEl.classList.remove('hidden');
            }
        }

        function showLog(message) {
            const log = document.getElementById('log');
            log.classList.remove('hidden');
            const time = new Date().toLocaleTimeString();
            log.textContent += `${time}: ${message}\n`;
            log.scrollTop = log.scrollHeight;
        }

        function showStatus(message, type) {
            const status = document.getElementById('authStatus');
            status.textContent = message;
            status.className = `status status-${type}`;
        }

        function showSuccess() {
            document.getElementById('successMsg').classList.remove('hidden');
            document.getElementById('downloadBtn').classList.remove('hidden');
            showStats();
        }

        function showStats() {
            const container = document.getElementById('stats');
            const data = state.generatedData;
            
            const opportunities = data.opportunities || [];
            const wonOpps = opportunities.filter(o => o.status === 'Won');
            const totalRevenue = wonOpps.reduce((sum, o) => sum + (o.actualRevenue || 0), 0);

            container.innerHTML = `
                <div class="stat">
                    <div class="stat-number">${data.accounts?.length || 0}</div>
                    <div class="stat-label">Accounts</div>
                </div>
                <div class="stat">
                    <div class="stat-number">${opportunities.length}</div>
                    <div class="stat-label">Opportunities</div>
                </div>
                <div class="stat">
                    <div class="stat-number">${wonOpps.length}</div>
                    <div class="stat-label">Won Deals</div>
                </div>
                <div class="stat">
                    <div class="stat-number">${(totalRevenue / 1000000).toFixed(1)}M</div>
                    <div class="stat-label">Revenue</div>
                </div>
                <div class="stat">
                    <div class="stat-number">${data.opportunityproducts?.length || 0}</div>
                    <div class="stat-label">Products</div>
                </div>
            `;
            container.classList.remove('hidden');
        }

        function downloadFiles() {
            try {
                showLog('Preparing download...');
                
                const zip = new JSZip();
                const data = state.generatedData;

                // Add each entity as CSV
                Object.keys(data).forEach(entityType => {
                    const entityData = data[entityType];
                    if (entityData && entityData.length > 0) {
                        const csv = Papa.unparse(entityData);
                        zip.file(`${entityType}.csv`, csv);
                        showLog(`Added ${entityType}.csv`);
                    }
                });

                // Add instructions
                const instructions = generateInstructions();
                zip.file('README.txt', instructions);

                // Download
                const fileName = `${state.demoType === 'contoso' ? 'Contoso_Coffee' : state.customerName.replace(/\s+/g, '_')}_${state.scenario}_${new Date().toISOString().split('T')[0]}.zip`;
                
                zip.generateAsync({ type: 'blob' }).then(content => {
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(content);
                    link.download = fileName;
                    link.click();
                    showLog(`Downloaded: ${fileName}`);
                });

            } catch (error) {
                showLog('Download failed: ' + error.message);
            }
        }

        function generateInstructions() {
            const data = state.generatedData;
            return `D365 Demo Data Generator - Instructions

GENERATED: ${new Date().toLocaleString()}
DEMO TYPE: ${state.demoType === 'contoso' ? 'Contoso Coffee' : 'Customer-Specific'}
${state.demoType === 'custom' ? `CUSTOMER: ${state.customerName}` : ''}
${state.demoType === 'custom' ? `INDUSTRY: ${state.industry}` : ''}
SCENARIO: ${state.scenario}

üìä DATA SUMMARY:
${Object.keys(data).map(key => `- ${key}: ${data[key]?.length || 0} records`).join('\n')}

üìã IMPORT ORDER:
1. currencies.csv
2. businessunits.csv  
3. users.csv
4. territories.csv
5. campaigns.csv
6. products.csv
7. accounts.csv
8. contacts.csv
9. opportunities.csv
10. opportunityproducts.csv

‚úÖ FEATURES:
- Every opportunity has products with calculated revenue
- Industry-specific data (${state.demoType === 'custom' ? state.industry : 'Coffee'})
- Realistic sales cycles and win rates
${state.scenario === 'agentic' || state.scenario === 'complete' ? '- AI Deal Close Agent included\n' : ''}
üéØ SUCCESS:
- Complete referential integrity
- Ready for D365 import
- Production-quality demo data

Generated by D365 Demo Data Generator
`;
        }
    </script>
</body>
</html>
