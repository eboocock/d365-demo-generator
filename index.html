<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dynamics 365 Sales Demo Data Generator</title>
  <style>
    :root { --bg1:#667eea; --bg2:#764ba2; --ink:#1f2937; --muted:#6b7280; --ring:#d1d5db; }
    *{box-sizing:border-box}
    body{margin:0;font-family:"Segoe UI",Tahoma,Verdana,sans-serif;min-height:100vh;display:grid;place-items:start;background:linear-gradient(135deg,var(--bg1),var(--bg2));color:var(--ink);padding:24px}
    .container{width:min(1100px,100%);margin-inline:auto;background:rgba(255,255,255,.95);backdrop-filter:blur(8px);border-radius:20px;box-shadow:0 18px 40px rgba(0,0,0,.12);padding:28px}
    h1{margin:0 0 6px;background:linear-gradient(135deg,var(--bg1),var(--bg2));-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent;font-size:clamp(22px,3vw,34px);}
    p.lead{margin:0 0 20px;color:var(--muted)}
    .section{background:#f8fafc;border-left:5px solid var(--bg1);border-radius:14px;padding:18px;margin:16px 0}
    .row{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:16px}
    label{font-weight:600;color:#0f172a;margin-bottom:6px;display:block}
    select,input[type="text"],input[type="file"]{width:100%;padding:12px;border:2px solid var(--ring);border-radius:10px;font-size:15px}
    select:focus,input:focus{outline:none;border-color:var(--bg1);box-shadow:0 0 0 3px rgba(102,126,234,.15)}
    .hint{color:var(--muted);font-size:13px;margin-top:6px}
    .hidden{display:none}
    .buttons{display:flex;flex-wrap:wrap;gap:12px;justify-content:center;margin-top:18px}
    .btn{border:0;border-radius:999px;padding:14px 22px;font-weight:700;cursor:pointer;display:inline-flex;align-items:center;gap:10px;min-width:180px;justify-content:center}
    .primary{color:white;background:linear-gradient(135deg,var(--bg1),var(--bg2))}
    .secondary{color:white;background:linear-gradient(135deg,#2ecc71,#27ae60)}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .progress{height:8px;background:#e5e7eb;border-radius:99px;overflow:hidden;margin-top:14px}
    .fill{height:100%;width:0;background:linear-gradient(90deg,var(--bg1),var(--bg2));transition:width .25s ease}
    pre.log{background:#0f172a;color:#e5e7eb;border-radius:12px;padding:14px;max-height:220px;overflow:auto;font-family:Consolas,monospace;font-size:12.5px;margin-top:16px;display:none}
    ul.key{margin:10px 0 0 18px;color:#334155}
    .warn{background:#fff7ed;border:1px solid #fdba74;color:#9a3412;padding:10px;border-radius:10px;margin:10px 0;display:none}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üöÄ Dynamics 365 Sales Demo Data Generator</h1>
      <p class="lead">Two inputs only‚Äîpick your demo type and user list, then download CSVs.</p>
      <div id="cdnWarn" class="warn">Having trouble loading libraries from CDNs. If this persists, check network/ad-block settings or host papaparse/jszip locally.</div>
    </header>

    <!-- Input #1: Demo Type -->
    <section class="section">
      <h3>üéØ Demo Type</h3>
      <div class="row">
        <div>
          <label for="demoType">Select demo</label>
          <select id="demoType">
            <option value="contoso">Contoso Coffee</option>
            <option value="custom">Custom</option>
          </select>
          <p class="hint">If you choose Custom, provide a customer name. All other business config is fixed to the sample data.</p>
        </div>
        <div id="customNameWrap" class="hidden">
          <label for="customerName">Customer name (required for Custom)</label>
          <input id="customerName" type="text" placeholder="e.g., Trey Research" />
          <p class="hint">Used to generate a minimal businessunit.csv in the package.</p>
        </div>
      </div>
    </section>

    <!-- Input #2: Users -->
    <section class="section">
      <h3>üë• Demo Users</h3>
      <div class="row">
        <div>
          <label for="userMode">Select users</label>
          <select id="userMode">
            <option value="contoso">Contoso Coffee (sample)</option>
            <option value="custom">Custom (upload users.csv)</option>
          </select>
          <p class="hint">If you choose Custom, upload a CSV matching the columns in the sample <code>User.csv</code>.</p>
        </div>
        <div id="customUsersWrap" class="hidden">
          <label for="usersFile">Upload custom users.csv</label>
          <input id="usersFile" type="file" accept=".csv" />
          <p class="hint">We validate headers and replace the sample users file in the package.</p>
        </div>
      </div>
    </section>

    <div class="buttons">
      <button id="generateBtn" class="btn primary">üé≤ Prepare Demo Package</button>
      <button id="downloadBtn" class="btn secondary" disabled>üíæ Download CSV ZIP</button>
    </div>

    <div class="progress"><div id="bar" class="fill"></div></div>
    <pre id="log" class="log"></pre>

    <section class="section">
      <h4>üì¶ What‚Äôs included</h4>
      <ul class="key">
        <li>Uses the sample CSVs in <code>/data/</code> (no other inputs needed).</li>
        <li>Only two choices: <em>Demo Type</em> and <em>Users</em>.</li>
        <li>Custom Demo Type changes the business unit name (via generated <code>businessunit.csv</code>).</li>
        <li>Custom Users replaces <code>User.csv</code> with your uploaded file; all other datasets remain as-is.</li>
      </ul>
    </section>
  </div>

  <script>
    // Robust multi-CDN loader
    function loadScriptSequential(urls, testFn, timeoutMs = 120000) {
      return new Promise((resolve, reject) => {
        let i = 0;
        let done = false;
        const warn = document.getElementById('cdnWarn');
        const start = Date.now();

        const next = () => {
          if (done) return;
          if (testFn()) { done = true; return resolve(); }
          if (i >= urls.length) {
            warn.style.display = 'block';
            return reject(new Error('Failed to load required library from all CDNs.'));
          }
          const url = urls[i++];
          const s = document.createElement('script');
          s.src = url;
          s.async = true;
          s.onload = () => { if (testFn()) { done = true; resolve(); } else { next(); } };
          s.onerror = () => { next(); };
          document.head.appendChild(s);

          const checkTimeout = () => {
            if (done) return;
            if (Date.now() - start > timeoutMs) {
              warn.style.display = 'block';
              reject(new Error('CDN load timeout.'));
            } else {
              setTimeout(() => {
                if (!done && !testFn()) { /* keep waiting */ }
              }, 500);
            }
          };
          setTimeout(checkTimeout, 5000);
        };
        next();
      });
    }

    const papaCDNs = [
      "https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js",
      "https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js",
      "https://unpkg.com/papaparse@5.4.1/papaparse.min.js"
    ];
    const jszipCDNs = [
      "https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js",
      "https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js",
      "https://unpkg.com/jszip@3.10.1/dist/jszip.min.js"
    ];

    // Bootstrap
    (async function bootstrap(){
      try{
        await loadScriptSequential(papaCDNs, ()=>window.Papa !== undefined);
        await loadScriptSequential(jszipCDNs, ()=>window.JSZip !== undefined);
        window.__libsReady = true;
        initApp();
      }catch(err){
        console.error(err);
        const log = (msg)=>{ const el=document.getElementById('log'); el.style.display='block'; el.textContent += `[${new Date().toLocaleTimeString()}] ${msg}\n`; el.scrollTop=el.scrollHeight; };
        log('‚ùå Could not load required libraries. If you are on a restricted network, allow cdnjs/jsDelivr/unpkg or host papaparse/jszip locally.');
      }
    })();

    function initApp(){
      // === Settings & state ===
      const RELATIVE_SAMPLE_FILES = [
        'data/Territory.csv',
        'data/Appointments.csv',
        'data/Contact.csv',
        'data/Goal.csv',
        'data/Campaign.csv',
        'data/User.csv',
        'data/Product.csv',
        'data/Opportunity.csv',
        'data/Account.csv',
        'data/Emails.csv'
      ];

      let packageData = {}; // { filename: [{row},...] }
      let customUsers = null; // parsed array of rows

      // === DOM helpers ===
      const $ = (id)=>document.getElementById(id);
      const log = (msg)=>{ const el=$('log'); el.style.display='block'; el.textContent += `[${new Date().toLocaleTimeString()}] ${msg}\n`; el.scrollTop=el.scrollHeight; };
      const setBar = (p)=>{ $('bar').style.width = `${p}%`; };

      // === UI behavior ===
      $('demoType').addEventListener('change', (e)=>{
        const isCustom = e.target.value === 'custom';
        $('customNameWrap').classList.toggle('hidden', !isCustom);
      });
      $('userMode').addEventListener('change', (e)=>{
        const isCustom = e.target.value === 'custom';
        $('customUsersWrap').classList.toggle('hidden', !isCustom);
      });

      $('usersFile').addEventListener('change', async (e)=>{
        const file = e.target.files?.[0];
        if(!file){ customUsers=null; return; }
        const text = await file.text();
        const parsed = Papa.parse(text, {header:true, skipEmptyLines:true});
        if(parsed.errors?.length){
          log(`‚ùå users.csv parse errors: ${parsed.errors[0].message}`);
          customUsers=null; return;
        }
        // Basic header validation against sample file once it's loaded
        if(packageData['data/User.csv']){
          const sampleHeaders = Object.keys(packageData['data/User.csv'][0]||{});
          const uploadedHeaders = parsed.meta.fields || [];
          const missing = sampleHeaders.filter(h=>!uploadedHeaders.includes(h));
          if(missing.length){
            log(`‚ùå users.csv missing column(s): ${missing.join(', ')}`);
            customUsers=null; return;
          }
        }
        customUsers = parsed.data;
        log(`‚úÖ Loaded custom users.csv with ${customUsers.length} rows.`);
      });

      // === Data loading ===
      async function fetchCSV(path){
        const res = await fetch(path, { cache: 'no-store' });
        if(!res.ok) throw new Error(`${path} not found (ensure CSVs are in /data/)`);
        const text = await res.text();
        const parsed = Papa.parse(text, {header:true, skipEmptyLines:true});
        if(parsed.errors?.length){
          throw new Error(`${path} parse error: ${parsed.errors[0].message}`);
        }
        return parsed.data;
      }

      async function loadSamples(){
        packageData = {};
        setBar(0);
        const step = 80/RELATIVE_SAMPLE_FILES.length; // first 80% of bar used for reads
        for(let i=0;i<RELATIVE_SAMPLE_FILES.length;i++){
          const f = RELATIVE_SAMPLE_FILES[i];
          log(`‚¨áÔ∏è Loading ${f} ...`);
          packageData[f] = await fetchCSV(f);
          setBar(Math.min(80, (i+1)*step));
        }
        log('‚úÖ All sample CSVs loaded.');
      }

      // === Light transforms ===
      function applyCustomizations(){
        const isCustomDemo = $('demoType').value === 'custom';
        const newName = $('customerName').value?.trim();
        const out = {...packageData};

        // Generate a minimal businessunit.csv
        const businessUnit = [];
        if(isCustomDemo){
          if(!newName){ throw new Error('Customer name is required for Custom demo.'); }
          businessUnit.push({
            'Business Unit ID': (crypto.randomUUID && crypto.randomUUID()) || Math.random().toString(36).slice(2),
            'Name': newName,
            'Description': `Primary business unit for ${newName}`,
            'Parent Business Unit': '',
            'Address 1: City': 'Seattle',
            'Address 1: State/Province': 'Washington',
            'Email Address': `info@${newName.toLowerCase().replace(/\s+/g,'')}.com`,
            'Website': `www.${newName.toLowerCase().replace(/\s+/g,'')}.com`
          });
          log(`‚úèÔ∏è Set Business Unit name to "${newName}".`);
        } else {
          businessUnit.push({
            'Business Unit ID': (crypto.randomUUID && crypto.randomUUID()) || Math.random().toString(36).slice(2),
            'Name': 'Contoso Coffee',
            'Description': 'Primary business unit for Contoso Coffee',
            'Parent Business Unit': '',
            'Address 1: City': 'Seattle',
            'Address 1: State/Province': 'Washington',
            'Email Address': 'info@contosocoffee.com',
            'Website': 'www.contosocoffee.com'
          });
        }
        out['businessunit.csv'] = businessUnit;

        // Swap users dataset if custom uploaded
        if($('userMode').value === 'custom'){
          if(!customUsers){ throw new Error('Please upload a users.csv before preparing the package.'); }
          out['data/User.csv'] = customUsers;
          log(`üë• Replaced User.csv with your custom upload (${customUsers.length} rows).`);
        }

        return out;
      }

      // === Package & download ===
      function toCSV(rows){ return Papa.unparse(rows || []); }

      async function buildZip(finalData){
        const zip = new JSZip();
        Object.keys(finalData).forEach(fname=>{
          const rows = finalData[fname];
          if(Array.isArray(rows) && rows.length){
            const cleanName = fname.replace(/^data\//, '');
            zip.file(cleanName, toCSV(rows));
          }
        });

        const instructions = `D365 DEMO DATA PACKAGE\n\nCONTENTS:\n- Sample datasets from /data.\n- businessunit.csv generated from your Demo Type selection.\n- User.csv may be replaced by your uploaded users.csv if chosen.\n\nHOW TO IMPORT (typical order):\n1. businessunit.csv\n2. User.csv\n3. Territory.csv\n4. Campaign.csv\n5. Product.csv\n6. Account.csv\n7. Contact.csv\n8. Opportunity.csv\n9. Emails.csv\n10. Appointments.csv\n\nNOTE: Adjust order to match your org‚Äôs schema & dependencies.`;
        zip.file('INSTRUCTIONS.txt', instructions);

        const blob = await zip.generateAsync({type:'blob'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `D365-Demo-Data-${new Date().toISOString().slice(0,10)}.zip`;
        document.body.appendChild(a); a.click(); a.remove();
        URL.revokeObjectURL(url);
        log('üì¶ ZIP download started.');
      }

      // === Orchestrate ===
      document.getElementById('generateBtn').addEventListener('click', async ()=>{
        try{
          document.getElementById('downloadBtn').disabled = True;
        }catch(e){}
        try{
          document.getElementById('downloadBtn').disabled = true;
          document.getElementById('log').textContent = '';
          setBar(0); log('Starting‚Ä¶');
          await loadSamples();
          setBar(85);
          const finalData = applyCustomizations();
          setBar(95); log('Package prepared. Ready to download.');
          window.__finalData = finalData;
          document.getElementById('downloadBtn').disabled = false;
          setBar(100);
        }catch(err){
          log(`‚ùå ${err.message}`);
        }
      });

      document.getElementById('downloadBtn').addEventListener('click', async ()=>{
        try{
          if(!window.__finalData){ throw new Error('Nothing to download yet. Click "Prepare Demo Package" first.'); }
          await buildZip(window.__finalData);
        }catch(err){ log(`‚ùå ${err.message}`) }
      });

      // Initial state
      (function init(){
        log('Ready. Ensure your CSVs live in /data next to this page, then click Prepare.');
      })();
    }
  </script>
</body>
</html>