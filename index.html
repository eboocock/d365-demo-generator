<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dynamics 365 Sales Demo Data Generator</title>
  <style>
    :root { --bg1:#667eea; --bg2:#764ba2; --ink:#1f2937; --muted:#6b7280; --ring:#d1d5db; }
    *{box-sizing:border-box}
    body{margin:0;font-family:"Segoe UI",Tahoma,Verdana,sans-serif;min-height:100vh;display:grid;place-items:start;background:linear-gradient(135deg,var(--bg1),var(--bg2));color:var(--ink);padding:24px}
    .container{width:min(1100px,100%);margin-inline:auto;background:rgba(255,255,255,.95);backdrop-filter:blur(8px);border-radius:20px;box-shadow:0 18px 40px rgba(0,0,0,.12);padding:28px}
    h1{margin:0 0 6px;background:linear-gradient(135deg,var(--bg1),var(--bg2));-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent;font-size:clamp(22px,3vw,34px);}
    p.lead{margin:0 0 20px;color:var(--muted)}
    .section{background:#f8fafc;border-left:5px solid var(--bg1);border-radius:14px;padding:18px;margin:16px 0}
    .row{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:16px}
    label{font-weight:600;color:#0f172a;margin-bottom:6px;display:block}
    select,input[type="text"],input[type="file"]{width:100%;padding:12px;border:2px solid var(--ring);border-radius:10px;font-size:15px}
    select:focus,input:focus{outline:none;border-color:var(--bg1);box-shadow:0 0 0 3px rgba(102,126,234,.15)}
    .hint{color:var(--muted);font-size:13px;margin-top:6px}
    .hidden{display:none}
    .buttons{display:flex;flex-wrap:wrap;gap:12px;justify-content:center;margin-top:18px}
    .btn{border:0;border-radius:999px;padding:14px 22px;font-weight:700;cursor:pointer;display:inline-flex;align-items:center;gap:10px;min-width:180px;justify-content:center}
    .primary{color:white;background:linear-gradient(135deg,var(--bg1),var(--bg2))}
    .secondary{color:white;background:linear-gradient(135deg,#2ecc71,#27ae60)}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .progress{height:8px;background:#e5e7eb;border-radius:99px;overflow:hidden;margin-top:14px}
    .fill{height:100%;width:0;background:linear-gradient(90deg,var(--bg1),var(--bg2));transition:width .25s ease}
    pre.log{background:#0f172a;color:#e5e7eb;border-radius:12px;padding:14px;max-height:260px;overflow:auto;font-family:Consolas,monospace;font-size:12.5px;margin-top:16px;display:none}
    ul.key{margin:10px 0 0 18px;color:#334155}
    .warn{background:#fff7ed;border:1px solid #fdba74;color:#9a3412;padding:10px;border-radius:10px;margin:10px 0;display:none}
    code.k{background:#eef2ff;padding:1px 6px;border-radius:6px}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üöÄ Dynamics 365 Sales Demo Data Generator</h1>
      <p class="lead">Two inputs only‚Äîpick your demo type and user list, then download CSVs.</p>
      <div id="cdnWarn" class="warn">Trouble loading CDNs? Whitelist cdnjs/jsDelivr/unpkg or host papaparse/jszip locally.</div>
    </header>

    <section class="section">
      <h3>üéØ Demo Type</h3>
      <div class="row">
        <div>
          <label for="demoType">Select demo</label>
          <select id="demoType">
            <option value="contoso">Contoso Coffee</option>
            <option value="custom">Custom</option>
          </select>
          <p class="hint">If Custom, provide a customer name. The app personalizes content around that brand.</p>
        </div>
        <div id="customNameWrap" class="hidden">
          <label for="customerName">Customer name (required for Custom)</label>
          <input id="customerName" type="text" placeholder="e.g., Trey Research" />
          <p class="hint">Used for <code class="k">businessunit.csv</code> and text personalization.</p>
        </div>
      </div>
    </section>

    <section class="section">
      <h3>üë• Demo Users</h3>
      <div class="row">
        <div>
          <label for="userMode">Select users</label>
          <select id="userMode">
            <option value="contoso">Contoso Coffee (sample)</option>
            <option value="custom">Custom (upload users.csv)</option>
          </select>
          <p class="hint">If Custom, upload a CSV matching the columns in the sample <code>User.csv</code>.</p>
        </div>
        <div id="customUsersWrap" class="hidden">
          <label for="usersFile">Upload custom users.csv</label>
          <input id="usersFile" type="file" accept=".csv" />
          <p class="hint">We validate headers and will assign record ownership based on your users for scenarios (2) and (4).</p>
        </div>
      </div>
    </section>

    <div class="buttons">
      <button id="generateBtn" class="btn primary">üé≤ Prepare Demo Package</button>
      <button id="downloadBtn" class="btn secondary" disabled>üíæ Download CSV ZIP</button>
    </div>

    <div class="progress"><div id="bar" class="fill"></div></div>
    <pre id="log" class="log"></pre>

    <section class="section">
      <h4>üì¶ Scenarios implemented</h4>
      <ul class="key">
        <li><strong>(1)</strong> Demo=Contoso, Users=Contoso ‚Üí output sample data as-is.</li>
        <li><strong>(2)</strong> Demo=Contoso, Users=Custom ‚Üí sample data, but reassign Owner columns round-robin to your uploaded users.</li>
        <li><strong>(3)</strong> Demo=Custom, Users=Contoso ‚Üí personalize text content to your Customer name (keep sample ownership).</li>
        <li><strong>(4)</strong> Demo=Custom, Users=Custom ‚Üí personalize text + assign ownership using your uploaded users.</li>
      </ul>
    </section>
  </div>

  <script>
    function loadScriptSequential(urls, testFn, timeoutMs = 120000) {
      return new Promise((resolve, reject) => {
        let i = 0, done = false;
        const warn = document.getElementById('cdnWarn');
        const start = Date.now();
        const next = () => {
          if (done) return;
          if (testFn()) { done = true; return resolve(); }
          if (i >= urls.length) {
            warn.style.display = 'block';
            return reject(new Error('Failed to load required library from all CDNs.'));
          }
          const s = document.createElement('script');
          s.src = urls[i++]; s.async = true;
          s.onload = () => { if (testFn()) { done = true; resolve(); } else { next(); } };
          s.onerror = next;
          document.head.appendChild(s);
          setTimeout(()=>{
            if (!done && (Date.now()-start)>timeoutMs){ warn.style.display='block'; reject(new Error('CDN load timeout.')); }
          }, 5000);
        };
        next();
      });
    }
    const papaCDNs = [
      "https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js",
      "https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js",
      "https://unpkg.com/papaparse@5.4.1/papaparse.min.js"
    ];
    const jszipCDNs = [
      "https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js",
      "https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js",
      "https://unpkg.com/jszip@3.10.1/dist/jszip.min.js"
    ];

    (async function bootstrap(){
      try{
        await loadScriptSequential(papaCDNs, ()=>window.Papa !== undefined);
        await loadScriptSequential(jszipCDNs, ()=>window.JSZip !== undefined);
        initApp();
      }catch(err){
        console.error(err);
        const log = (msg)=>{ const el=document.getElementById('log'); el.style.display='block'; el.textContent += `[${new Date().toLocaleTimeString()}] ${msg}
`; el.scrollTop=el.scrollHeight; };
        log('‚ùå Could not load required libraries. If your network blocks CDNs, host papaparse/jszip locally.');
      }
    })();
  </script>

  <script>
    const RELATIVE_SAMPLE_FILES = [
      'data/Territory.csv','data/Appointments.csv','data/Contact.csv','data/Goal.csv','data/Campaign.csv','data/User.csv','data/Product.csv','data/Opportunity.csv','data/Account.csv','data/Emails.csv'
    ];
    let packageData = {}; let customUsers = null;
    const $ = (id)=>document.getElementById(id);
    const log = (msg)=>{ const el=$('log'); el.style.display='block'; el.textContent += `[${new Date().toLocaleTimeString()}] ${msg}
`; el.scrollTop=el.scrollHeight; };
    const setBar = (p)=>{ $('bar').style.width = `${p}%`; };

    $('demoType').addEventListener('change', (e)=>{ $('customNameWrap').classList.toggle('hidden', e.target.value !== 'custom'); });
    $('userMode').addEventListener('change', (e)=>{ $('customUsersWrap').classList.toggle('hidden', e.target.value !== 'custom'); });

    $('usersFile').addEventListener('change', async (e)=>{
      const file = e.target.files && e.target.files[0];
      if(!file){ customUsers=null; return; }
      const text = await file.text();
      const parsed = Papa.parse(text, {header:true, skipEmptyLines:true});
      if(parsed.errors && parsed.errors.length){ log(`‚ùå users.csv parse errors: ${parsed.errors[0].message}`); customUsers=null; return; }
      if(packageData['data/User.csv']){
        const sampleHeaders = Object.keys(packageData['data/User.csv'][0]||{});
        const uploadedHeaders = parsed.meta.fields || [];
        const missing = sampleHeaders.filter(h=>uploadedHeaders.indexOf(h)===-1);
        if(missing.length){ log(`‚ùå users.csv missing column(s): ${missing.join(', ')}`); customUsers=null; return; }
      }
      customUsers = parsed.data;
      log(`‚úÖ Loaded custom users.csv with ${customUsers.length} rows.`);
    });

    async function fetchCSV(path){
      const res = await fetch(path, { cache: 'no-store' });
      if(!res.ok) throw new Error(`${path} not found (ensure CSVs are in /data/)`);
      const text = await res.text();
      const parsed = Papa.parse(text, {header:true, skipEmptyLines:true});
      if(parsed.errors && parsed.errors.length){ throw new Error(`${path} parse error: ${parsed.errors[0].message}`); }
      return parsed.data;
    }
    async function loadSamples(){
      packageData = {}; setBar(0);
      const step = 70/RELATIVE_SAMPLE_FILES.length;
      for(let i=0;i<RELATIVE_SAMPLE_FILES.length;i++){
        const f = RELATIVE_SAMPLE_FILES[i];
        log(`‚¨áÔ∏è Loading ${f} ...`);
        packageData[f] = await fetchCSV(f);
        setBar(Math.min(70,(i+1)*step));
      }
      log('‚úÖ All sample CSVs loaded.');
    }

    // column detection without regex literals (header includes checks)
    function detectOwnerCols(row){
      const keys = Object.keys(row || {});
      return keys.filter(k=>{
        const s=k.toLowerCase();
        return s.includes('owning user') || s.includes('owning team') || (s.includes('owner') && !s.includes('account owner') && !s.includes('created') && !s.includes('modified'));
      });
    }
    function detectBuCols(row){
      const keys = Object.keys(row || {});
      return keys.filter(k=>{
        const s=k.toLowerCase();
        return s.includes('owning business unit') || (s.includes('business') && s.includes('unit'));
      });
    }
    const TEXT_TOKENS = ['name','title','subject','topic','description','campaign','opportun','appointment','meeting','activity','regarding','note'];
    function detectTextCols(row){
      const keys = Object.keys(row || {});
      return keys.filter(k=>{
        const s=k.toLowerCase();
        return TEXT_TOKENS.some(t=>s.indexOf(t)!==-1);
      });
    }
    const BRAND_TOKENS = ['contoso coffee','contosocoffee','contoso.com'];
    function cellHasBrand(v){
      return typeof v==='string' && BRAND_TOKENS.some(t=>v.toLowerCase().indexOf(t)!==-1);
    }

    function getUserDisplay(u){
      return u['Full Name'] || ([u['First Name']||'', u['Last Name']||''].join(' ').trim()) || u['User Name'] || u['Primary Email'] || u['Email'] || u['UPN'] || 'Unknown User';
    }
    function roundRobinOwners(rows, users){
      if(!rows || !rows.length || !users || !users.length) return rows;
      const ownerCols = detectOwnerCols(rows[0]);
      if(!ownerCols.length) return rows;
      const names = users.map(getUserDisplay);
      let i=0;
      return rows.map(r=>{
        const nr={...r};
        ownerCols.forEach(col=>{ nr[col] = names[i % names.length]; });
        i++; return nr;
      });
    }

    function slugify(n){ return (n||'').toLowerCase().replace(/[^a-z0-9]+/g,'').slice(0,40) || 'customer'; }
    function personalizeRows(rows, customerName){
      if(!rows || !rows.length) return rows;
      const first = rows[0] || {};
      const textCols = detectTextCols(first);
      const buCols = detectBuCols(first);
      const domain = slugify(customerName);
      return rows.map(r=>{
        const nr = {...r};
        Object.keys(nr).forEach(k=>{
          const val = nr[k];
          if(typeof val === 'string' && (textCols.indexOf(k)!==-1 || cellHasBrand(val))){
            let nv = val.split('Contoso Coffee').join(customerName).split('contosocoffee').join(domain);
            if(textCols.indexOf(k)!==-1 && nv.indexOf(customerName)===-1){
              nv = nv.replace(/\s*-?\s*$/,'') + ' ‚Äî ' + customerName;
            }
            nr[k] = nv;
          }
        });
        buCols.forEach(k=> nr[k] = customerName);
        return nr;
      });
    }

    function generateBusinessUnit(customerName){
      const name = (customerName && customerName.trim()) || 'Contoso Coffee';
      const id = (crypto.randomUUID && crypto.randomUUID()) || Math.random().toString(36).slice(2);
      return [{
        'Business Unit ID': id,
        'Name': name,
        'Description': 'Primary business unit for ' + name,
        'Parent Business Unit': '',
        'Address 1: City': 'Seattle',
        'Address 1: State/Province': 'Washington',
        'Email Address': 'info@' + slugify(name) + '.com',
        'Website': 'www.' + slugify(name) + '.com'
      }];
    }

    function applyScenario(){
      const demoType = $('demoType').value;
      const userMode = $('userMode').value;
      const customerName = ($('customerName').value || '').trim();
      const out = {...packageData};

      if(demoType === 'custom'){
        if(!customerName){ throw new Error('Customer name is required when Demo Type is Custom.'); }
        out['businessunit.csv'] = generateBusinessUnit(customerName);
      } else {
        out['businessunit.csv'] = generateBusinessUnit('Contoso Coffee');
      }

      if(userMode === 'custom'){
        if(!customUsers){ throw new Error('Please upload a users.csv before preparing the package.'); }
        out['data/User.csv'] = customUsers;
      }

      const isCustomDemo = demoType === 'custom';
      const hasCustomUsers = userMode === 'custom';

      Object.keys(out).forEach(fname=>{
        if(fname === 'data/User.csv' || fname === 'businessunit.csv') return;
        let rows = out[fname];
        if(!Array.isArray(rows) || !rows.length) return;
        if(isCustomDemo){ rows = personalizeRows(rows, customerName); }
        if(hasCustomUsers){ rows = roundRobinOwners(rows, customUsers); }
        out[fname] = rows;
      });

      const scenario = (!isCustomDemo && !hasCustomUsers) ? '(1) Contoso + Contoso' : (!isCustomDemo && hasCustomUsers) ? '(2) Contoso + Custom (owners reassigned)' : (isCustomDemo && !hasCustomUsers) ? '(3) Custom + Contoso (personalized)' : '(4) Custom + Custom (personalized + owners reassigned)';
      log('üîÅ Applied scenario ' + scenario + '.');
      return out;
    }

    function toCSV(rows){ return Papa.unparse(rows || []); }
    async function buildZip(finalData){
      const zip = new JSZip();
      Object.keys(finalData).forEach(fname=>{
        const rows = finalData[fname];
        if(Array.isArray(rows) && rows.length){
          const cleanName = fname.replace(/^data\//, '');
          zip.file(cleanName, toCSV(rows));
        }
      });
      const instructions = 'D365 DEMO DATA PACKAGE\n\nSCENARIOS:\n(1) Contoso+Contoso -> sample as-is\n(2) Contoso+Custom -> owners reassigned\n(3) Custom+Contoso -> personalized\n(4) Custom+Custom -> personalized + owners reassigned\n\nIMPORT ORDER (typical):\n1. businessunit.csv\n2. User.csv\n3. Territory.csv\n4. Campaign.csv\n5. Product.csv\n6. Account.csv\n7. Contact.csv\n8. Opportunity.csv\n9. Emails.csv\n10. Appointments.csv';
      zip.file('INSTRUCTIONS.txt', instructions);
      const blob = await zip.generateAsync({type:'blob'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'D365-Demo-Data-' + new Date().toISOString().slice(0,10) + '.zip';
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      log('üì¶ ZIP download started.');
    }

    function initApp(){
      log('Ready. Ensure your sample CSVs are in /data/ next to this page and click Prepare.');
      document.getElementById('generateBtn').addEventListener('click', async ()=>{
        try{
          document.getElementById('downloadBtn').disabled = true;
          document.getElementById('log').textContent = '';
          setBar(0); log('Starting‚Ä¶');
          await loadSamples(); setBar(75);
          const finalData = applyScenario(); setBar(92);
          log('Package prepared. Ready to download.');
          window.__finalData = finalData;
          document.getElementById('downloadBtn').disabled = false; setBar(100);
        }catch(err){ log('‚ùå ' + err.message); }
      });
      document.getElementById('downloadBtn').addEventListener('click', async ()=>{
        try{
          if(!window.__finalData){ throw new Error('Nothing to download yet. Click "Prepare Demo Package" first.'); }
          await buildZip(window.__finalData);
        }catch(err){ log('‚ùå ' + err.message); }
      });
    }
  </script>
</body>
</html>